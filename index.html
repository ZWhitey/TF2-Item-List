<!DOCTYPE html>
<html>

<head>
    <title>Item Name</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="./js/paint.js"></script>
</head>
<script>
    var en_data = [-1, -1, -1, -1, -1];
    var tw_data = [-1, -1, -1, -1, -1];
    var en_unusual = null;
    var tw_unusual = null;
    var en = [];
    var tw = [];
    var data_conut = 0;
    function update() {
        var n = document.getElementById("cal_input");
        var input = n.value;
        var lines = input.split('\n');
        var data = [];
        for (var i = 0; i < lines.length; ++i) {
            if (lines[i].length == 0)
                continue;
            if (/^[0-9]*(\.[0-9]{2})?$/g.test(lines[i])) {
                data.push(lines[i]);
            }
        }
        var ref = 0;
        var rec = 0;
        var scrap = 0;
        for (var i = 0; i < data.length; i++) {
            tmp = data[i].split('.');
            ref += parseInt(tmp[0]);
            if (tmp.length == 2) {
                scrap += Math.round(parseInt(tmp[1]) / 11)
            }
        }
        if (scrap >= 9) {
            ref += Math.floor(scrap / 9);
            scrap %= 9;
        }
        if (scrap >= 3) {
            rec += Math.floor(scrap / 3);
            scrap %= 3;
        }
        $("#c_ref").text(`Refine Metal : ${ref}`);
        $("#c_rec").text(`Reclaimed Metal : ${rec}`);
        $("#c_scrap").text(`Scrap Metal : ${scrap}`);
    }
    $(function () {

        $("#Input").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#table tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        $.when($.getJSON("./item_data/en_1.json"),
            $.getJSON("./item_data/en_2.json"),
            $.getJSON("./item_data/en_3.json"),
            $.getJSON("./item_data/en_4.json"),
            $.getJSON("./item_data/en_5.json"),
            $.getJSON(`./item_data/zh-TW_1.json`),
            $.getJSON(`./item_data/zh-TW_2.json`),
            $.getJSON(`./item_data/zh-TW_3.json`),
            $.getJSON(`./item_data/zh-TW_4.json`),
            $.getJSON(`./item_data/zh-TW_5.json`),
            $.getJSON(`./item_data/en_schema.json`),
            $.getJSON(`./item_data/zh-tw_schema.json`)

        ).done(function (en1, en2, en3, en4, en5, tw1, tw2, tw3, tw4, tw5, ens, tws) {
            tw = tw1[0]['result']['items'];
            tw = tw.concat(tw2[0]['result']['items']);
            tw = tw.concat(tw3[0]['result']['items']);
            tw = tw.concat(tw4[0]['result']['items']);
            tw = tw.concat(tw5[0]['result']['items']);
            en = en1[0]['result']['items'];
            en = en.concat(en2[0]['result']['items']);
            en = en.concat(en3[0]['result']['items']);
            en = en.concat(en4[0]['result']['items']);
            en = en.concat(en5[0]['result']['items']);
            en_unusual = ens[0]['result']['attribute_controlled_attached_particles'];
            tw_unusual = tws[0]['result']['attribute_controlled_attached_particles'];
            updateItemTable(0);
            showUTable();
            showPaintTable();
        });
    });
    function updateItemTable(start){
        var table = $("#table");
        table.empty();
        var cls = '';
        for(var i=start;i<tw.length;++i){
            if(i>= tw.length)
                break;
            cls = getUseClass(tw[i]["used_by_classes"]);
            table.append( `
                <tr>  
                    <td>${tw[i]["defindex"]}</td>            
                    <td><a href="javascript:void(0)" id="i_img_${tw[i]["defindex"]}" title="${tw[i]["item_name"]}" data-toggle="popover" data-trigger="focus" data-content="">${en[i]["item_name"]}</a></td>           
                    <td>${tw[i]["item_name"]}</td>
                    <td>${cls}</td>
                    <td>${tw[i]["item_class"]}</td>           
                </tr>
                `);
            var img = `<img src="${tw[i]['image_url']}">`;
            $(`#i_img_${tw[i]["defindex"]}`).popover({ content: img, html: true });
        }  
    }
    function getUseClass(classes){
        var cls = '';
        if (classes !== undefined) {
            if (classes.length == 0) {
                cls = 'All Class';
            }
            else {
                for (var k = 0; k < classes.length; ++k) {
                    cls += `<img src="./class_imgs/${classes[k]}.png" width="25" height="25">`
                }
            }
        }
        else {
            cls = 'All Class';
        }
        return cls;
    }
    function showPaintTable(){
        var p_table = $("#p_table");
        var tp = '';
        for(var i=0;i<tw.length;++i){
            if (paints.indexOf(tw[i]["defindex"]) != -1){
                if (tw[i]["attributes"].length == 1) {
                    tp += `
                            <tr>
                                <td>${tw[i]["defindex"]}</td>  
                                <td>${en[i]["item_name"]}</td>
                                <td>${tw[i]["item_name"]}</td>
                                <td style="background-color:${paints_rgb[tw[i]["defindex"]]}">${tw[i]["attributes"][0]['value']}</td>
                                <td style="background-color:${paints_rgb[tw[i]["defindex"]]}">${tw[i]["attributes"][0]['value']}</td>
                            </tr>
                            `;
                }
                else if (tw[i]["attributes"].length == 2) {
                    tp += `
                                <tr>
                                    <td>${tw[i]["defindex"]}</td>  
                                    <td>${en[i]["item_name"]}</td>
                                    <td>${tw[i]["item_name"]}</td>
                                    <td style="background-color:${paints_rgb[tw[i]["defindex"]][0]}">${tw[i]["attributes"][0]['value']}</td>
                                    <td style="background-color:${paints_rgb[tw[i]["defindex"]][1]}">${tw[i]["attributes"][1]['value']}</td>
                                </tr>
                                `;
                }
            }
        }
        p_table.append(tp);
    }
    function showUTable(){
        var utable = $("#u_table");
        var tb = '';
        for (var i = 0; i < en_unusual.length; ++i) {
            tb += `
                            <tr>
                                <td>${en_unusual[i]["id"]}</td>            
                                <td><a href="javascript:void(0)" id="u_img_${en_unusual[i]["id"]}" title="${en_unusual[i]["name"]}" data-toggle="popover" data-trigger="focus" data-content="">${en_unusual[i]["name"]}</a></td>           
                                <td>${tw_unusual[i]["name"]}</td>
                                <td>${en_unusual[i]["system"]}</td>           
                            </tr>`;
        }
        utable.append(tb);
        for (var i = 0; i < en_unusual.length; ++i) {
            var img = `<img src="imgs/${en_unusual[i]["id"]}.png">`;
            $(`#u_img_${en_unusual[i]["id"]}`).popover({ content: img, html: true });
        }
    }
    function showdata() {
        var table = $("#table");
        var p_table = $("#p_table");
        for (var j = 0; j < en_data.length; ++j) {
            var tb = '';
            var tp = '';
            for (var i = 0; i < en_data[j]["items"].length; ++i) {
                if (paints.indexOf(tw_data[j]["items"][i]["defindex"]) != -1) {
                    if (tw_data[j]["items"][i]["attributes"].length == 1) {
                        tp += `
                                <tr>
                                    <td>${tw_data[j]["items"][i]["defindex"]}</td>  
                                    <td>${en_data[j]["items"][i]["item_name"]}</td>
                                    <td>${tw_data[j]["items"][i]["item_name"]}</td>
                                    <td style="background-color:${paints_rgb[tw_data[j]["items"][i]["defindex"]]}">${tw_data[j]["items"][i]["attributes"][0]['value']}</td>
                                    <td style="background-color:${paints_rgb[tw_data[j]["items"][i]["defindex"]]}">${tw_data[j]["items"][i]["attributes"][0]['value']}</td>
                                </tr>
                                `;
                    }
                    else if (tw_data[j]["items"][i]["attributes"].length == 2) {
                        tp += `
                                    <tr>
                                        <td>${tw_data[j]["items"][i]["defindex"]}</td>  
                                        <td>${en_data[j]["items"][i]["item_name"]}</td>
                                        <td>${tw_data[j]["items"][i]["item_name"]}</td>
                                        <td style="background-color:${paints_rgb[tw_data[j]["items"][i]["defindex"]][0]}">${tw_data[j]["items"][i]["attributes"][0]['value']}</td>
                                        <td style="background-color:${paints_rgb[tw_data[j]["items"][i]["defindex"]][1]}">${tw_data[j]["items"][i]["attributes"][1]['value']}</td>
                                    </tr>
                                    `;
                    }
                }
                var cls = '';
                if (tw_data[j]["items"][i]["used_by_classes"] !== undefined) {
                    if (tw_data[j]["items"][i]["used_by_classes"].length == 0) {
                        cls = 'All Class';
                    }
                    else {
                        for (var k = 0; k < tw_data[j]["items"][i]["used_by_classes"].length; ++k) {
                            cls += `<img src="./class_imgs/${tw_data[j]["items"][i]["used_by_classes"][k]}.png" width="25" height="25">`
                        }
                    }
                }
                else {
                    cls = 'All Class';
                }

                tb += `
                                <tr>  
                                    <td>${tw_data[j]["items"][i]["defindex"]}</td>            
                                    <td><a href="javascript:void(0)" id="i_img_${tw_data[j]["items"][i]["defindex"]}" title="${en_data[j]["items"][i]["item_name"]}" data-toggle="popover" data-trigger="focus" data-content="">${en_data[j]["items"][i]["item_name"]}</a></td>           
                                    <td>${tw_data[j]["items"][i]["item_name"]}</td>
                                    <td>${cls}</td>
                                    <td>${tw_data[j]["items"][i]["item_class"]}</td>           
                                </tr>`;
            }
            table.append(tb);
            //table_data.append(tb);
            p_table.append(tp);
            for (var i = 0; i < en_data[j]["items"].length; ++i) {
                var img = `<img src="${tw_data[j]['items'][i]['image_url']}">`;
                $(`#i_img_${tw_data[j]["items"][i]["defindex"]}`).popover({ content: img, html: true });
            }
        }

        
    }
</script>

<body>
    <div class="jumbotron">
        <h1>Team Fortress 2 Item List</h1>
    </div>
    <div class="container">

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#Item">Item List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#menu1">Unusual</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#menu2">Paint Can</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#menu3">Metal Calculator</a>
            </li>
        </ul>
        <div class="tab-content">
            <div id="Item" class="tab-pane active container"><br>
                <br>
                <input type="text" id="Input">
                <div class="clusterize">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Name(en)</th>
                                <th>Name(zh-TW)</th>
                                <th>Class</th>
                                <th>Item Class</th>
                            </tr>
                        </thead>
                        <div>
                                <tbody id="table">
                                    
                                </tbody>
                            
                        </div>
                    </table>
                        <ul class="pagination justify-content-center">
                          <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Previous">
                              <span aria-hidden="true">&laquo;</span>
                              <span class="sr-only">Previous</span>
                            </a>
                          </li>
                          <li class="page-item active"><a class="page-link" href="#">1</a></li>
                          <li class="page-item"><a class="page-link" href="#">2</a></li>
                          <li class="page-item"><a class="page-link" href="#">3</a></li>
                          <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                              <span aria-hidden="true">&raquo;</span>
                              <span class="sr-only">Next</span>
                            </a>
                          </li>
                        </ul>
                </div>
            </div>
            <div id="menu1" class="tab-pane fade container"><br>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Name(en)</th>
                            <th>Name(zh-TW)</th>
                            <th>Particle System</th>
                        </tr>
                    </thead>
                    <tbody id="u_table">
                    </tbody>
                </table>
            </div>
            <div id="menu2" class="tab-pane fade container"><br>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Name(en)</th>
                            <th>Name(zh-TW)</th>
                            <th>Color Code (Red)</th>
                            <th>Color Code (Blue)</th>
                        </tr>
                    </thead>
                    <tbody id="p_table">
                    </tbody>
                </table>
            </div>
            <div id="menu3" class="tab-pane fade container"><br>
                <h3>Metal Calculator</h3>
                <div class="row">
                    <div class="col-lg-4">
                        <label for="cal_input">Price:</label>
                        <textarea class="form-control" rows="20" id="cal_input" onchange="update()"></textarea>
                    </div>
                    <div class="col-lg-8">
                        <h3 id="c_ref">Refine Metal : 0</h3>
                        <h3 id="c_rec">Reclaimed Metal : 0</h3>
                        <h3 id="c_scrap">Scrap Metal : 0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>